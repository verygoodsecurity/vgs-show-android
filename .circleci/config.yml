version: 2.1
jobs:
  build:
    working_directory: ~/code
    docker:
      - image: circleci/android:api-29
    environment:
      JVM_OPTS: -Xmx3200m
    steps:
      - checkout
      - restore_cache:
          key: jars-{{ checksum "build.gradle" }}-{{ checksum  "app/build.gradle" }}
      - run:
          name: Download Dependencies
          command: |
            sudo chmod +x gradlew
            ./gradlew androidDependencies
      - save_cache:
          paths:
            - ~/.gradle
          key: jars-{{ checksum "build.gradle" }}-{{ checksum  "app/build.gradle" }}

      # Generate apk
      - run: ./gradlew assembleDebug assembleAndroidTest

#      # run tests!
#      - run:
#          name: Run tests
#          command: ./gradlew test

      # Upload apk to BrowserStack and set app url in an environment variable.
      - run:
          name: Browserstack - upload app and set app id in environment variable.
          command: |
            APP_UPLOAD_RESPONSE=$(curl -u "vgsvendors1:xjSscpXkZ8pUHxxz6Nsd" -X POST https://api-cloud.browserstack.com/app-automate/upload -F "file=@app/build/outputs/apk/debug/app-debug.apk")
            echo "APP_UPLOAD_RESPONSE :  " + $APP_UPLOAD_RESPONSE
            APP_URL=$(echo $APP_UPLOAD_RESPONSE | jq -r ".app_url")
            if [ $APP_URL != null ]; then
              echo "Apk uploaded to BrowserStack with app_url : ",$APP_URL;
              echo "export BROWSERSTACK_APP_URL=$APP_URL" >> $BASH_ENV;
              source $BASH_ENV;
              echo "Setting value of BROWSERSTACK_APP_URL in environment variables to ",$APP_URL;
            else
              UPLOAD_ERROR_MESSAGE=$(echo $APP_UPLOAD_RESPONSE | jq -r ".error")
              echo "App upload failed, reason : ",$UPLOAD_ERROR_MESSAGE
              exit 1;
            fi

      # Upload tests apk to BrowserStack and set app url in an environment variable.
      - run:
          name: Browserstack - upload app and set test app id in environment variable.
          command: |
            APP_UPLOAD_RESPONSE=$(curl -u "vgsvendors1:xjSscpXkZ8pUHxxz6Nsd" -X POST "https://api-cloud.browserstack.com/app-automate/espresso/test-suite" -F "file=@app/build/outputs/apk/androidTest/debug/app-debug-androidTest.apk")
            echo "APP_UPLOAD_RESPONSE :  " + $APP_UPLOAD_RESPONSE
            TEST_URL=$(echo $APP_UPLOAD_RESPONSE | jq -r ".test_url")
            if [ $TEST_URL != null ]; then
              echo "Apk uploaded to BrowserStack with test test_url : ",$TEST_URL;
              echo "export BROWSERSTACK_TEST_URL=$TEST_URL" >> $BASH_ENV;
              source $BASH_ENV;
              echo "Setting value of BROWSERSTACK_TEST_URL in environment variables to ",TEST_URL;
            else
              UPLOAD_ERROR_MESSAGE=$(echo $APP_UPLOAD_RESPONSE | jq -r ".error")
              echo "App upload failed, reason : ",$UPLOAD_ERROR_MESSAGE
              exit 1;
            fi

      # Trigger BrowserStack tests.
      - run:
          name: Browserstack - execute espresso test.
          command: |
            echo "BROWSERSTACK_APP_URL",$BROWSERSTACK_APP_URL;
            echo "BROWSERSTACK_TEST_URL",$BROWSERSTACK_TEST_URL;
            RESPONSE=$(curl -X POST "https://api-cloud.browserstack.com/app-automate/espresso/build" -d  "{\"devices\": [\"Google Pixel 3-9.0\"], \"app\": \"$BROWSERSTACK_APP_URL\", \"deviceLogs\" : true, \"testSuite\": \"$BROWSERSTACK_TEST_URL\"}" -H "Content-Type: application/json" -u "vgsvendors1:xjSscpXkZ8pUHxxz6Nsd")
            echo "RESPONSE :  " + $RESPONSE
            MESSAGE=$(echo RESPONSE | jq -r ".message")
            if [ MESSAGE == "Success" ]; then
              echo "Esspresso tests triggered with build_id: ",$(echo RESPONSE | jq -r ".build_id");
            else
              echo "Esspresso tests not triggered, reason : ",MESSAGE
              exit 1;
            fi
