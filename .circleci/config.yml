version: 2.1
jobs:
  build:
    working_directory: ~/code
    docker:
      - image: circleci/android:api-29
    environment:
      JVM_OPTS: -Xmx3200m
    steps:
      - checkout
      - restore_cache:
          key: jars-{{ checksum "build.gradle" }}-{{ checksum  "app/build.gradle" }}
      - run:
          name: Download Dependencies
          command: |
            sudo chmod +x gradlew
            ./gradlew androidDependencies
      - save_cache:
          paths:
            - ~/.gradle
          key: jars-{{ checksum "build.gradle" }}-{{ checksum  "app/build.gradle" }}

      # Generate apk
      - run: ./gradlew assembleDebug assembleAndroidTest

      # run tests!
      - run:
          name: Run tests
          command: ./gradlew test

      # Upload apk to BrowserStack and set app url in an environment variable.
      - run:
          name: Browserstack - upload app and set app id in environment variable.
          command: |
            APP_UPLOAD_RESPONSE=$(curl -u "vgsvendors1:xjSscpXkZ8pUHxxz6Nsd" -X POST https://api-cloud.browserstack.com/app-automate/upload -F "file=@app/build/outputs/apk/debug/app-debug.apk")
            echo "APP_UPLOAD_RESPONSE :  " + $APP_UPLOAD_RESPONSE
            APP_ID=$(echo $APP_UPLOAD_RESPONSE | jq -r ".app_url")
            if [ $APP_ID != null ]; then
              echo "Apk uploaded to BrowserStack with app id : ",$APP_ID;
              echo "export BROWSERSTACK_APP_ID=$APP_ID" >> $BASH_ENV;
              source $BASH_ENV;
              echo "Setting value of BROWSERSTACK_APP_ID in environment variables to  ",$APP_ID;
            else
              UPLOAD_ERROR_MESSAGE=$(echo $APP_UPLOAD_RESPONSE | jq -r ".error")
              echo "App upload failed, reason : ",$UPLOAD_ERROR_MESSAGE
              exit 1;
            fi

      # Upload tests apk to BrowserStack and set app url in an environment variable.
      - run:
          name: Browserstack - upload app and set test app id in environment variable.
          command: |
            APP_UPLOAD_RESPONSE=$(curl -u "vgsvendors1:xjSscpXkZ8pUHxxz6Nsd" -X POST "https://api-cloud.browserstack.com/app-automate/espresso/test-suite" -F "file=@app/build/outputs/apk/androidTest/debug/app-debug-androidTest.apk")
            echo "APP_UPLOAD_RESPONSE :  " + $APP_UPLOAD_RESPONSE
            APP_TESTS_ID=$(echo $APP_UPLOAD_RESPONSE | jq -r ".test_url")
            if [ APP_TESTS_ID != null ]; then
              echo "Apk uploaded to BrowserStack with app id : ",APP_TESTS_ID;
              echo "export BROWSERSTACK_APP_TEST_ID=APP_TESTS_ID" >> $BASH_ENV;
              source $BASH_ENV;
              echo "Setting value of BROWSERSTACK_APP_TEST_ID in environment variables to  ",APP_TESTS_ID;
            else
              UPLOAD_ERROR_MESSAGE=$(echo $APP_UPLOAD_RESPONSE | jq -r ".error")
              echo "App upload failed, reason : ",$UPLOAD_ERROR_MESSAGE
              exit 1;
            fi

      # Trigger BrowserStack tests.
      - run:
          name: Browserstack - execute espresso test.
          command: |
            RESPONSE=$(curl -X POST "https://api-cloud.browserstack.com/app-automate/espresso/build" -d  "{\"devices\": [\"Google Pixel 3-9.0\"], \"app\": \"$BROWSERSTACK_APP_ID\", \"deviceLogs\" : true, \"testSuite\": \"$BROWSERSTACK_APP_TEST_ID\"}" -H "Content-Type: application/json" -u "vgsvendors1:xjSscpXkZ8pUHxxz6Nsd")
            echo "RESPONSE :  " + RESPONSE
            MESSAGE=$(echo RESPONSE | jq -r ".message")
            BUULD_ID=$(echo RESPONSE | jq -r ".build_id")
            if [ MESSAGE == "Success" ]; then
              echo "Esspresso tests triggered with build_id: ",BUULD_ID;
            else
              echo "Esspresso tests not triggered, reason : ",MESSAGE
              exit 1;
            fi
